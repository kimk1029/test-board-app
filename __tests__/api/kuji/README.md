# 쿠지 기능 테스트

## 테스트 실행 방법

### 기본 테스트 실행
```bash
npm test
# 또는
yarn test
```

### 쿠지 관련 테스트만 실행
```bash
npm run test:kuji
# 또는
yarn test:kuji
```

### 테스트 감시 모드 (파일 변경 시 자동 실행)
```bash
npm run test:watch
```

### 커버리지 리포트 생성
```bash
npm run test:coverage
```

## 테스트 케이스

### 1. 박스 상태 조회 API (`box.test.ts`)
- ✅ 최신 박스 상태 반환 확인
- ✅ 등급별 남은 수량 계산 정확성
- ✅ 캐싱 방지 헤더 설정 확인
- ✅ 뽑힌 티켓의 rank만 반환, 뽑히지 않은 티켓은 null 반환

### 2. 티켓 업데이트 API (`box.test.ts`)
- ✅ 티켓 뽑기 후 DB 업데이트 확인
- ✅ 이미 뽑힌 티켓 재뽑기 방지

### 3. 통합 테스트 (`box.test.ts`)
- ✅ 티켓 뽑기 → DB 업데이트 → 박스 상태 조회 → 재고 업데이트 확인

### 4. 실제 DB 통합 테스트 (`integration.test.ts`)
- ⚠️ 실제 DB를 사용한 통합 테스트 (선택적)
- 실행하려면: `USE_REAL_DB=true npm test`

## 주요 검증 사항

1. **최신 데이터 반환**
   - 티켓을 뽑은 후 즉시 box API를 호출하면 업데이트된 상태를 반환하는지 확인

2. **재고 업데이트 정확성**
   - 등급별 남은 수량이 정확히 계산되는지 확인
   - 여러 티켓을 동시에 뽑았을 때 재고가 정확히 차감되는지 확인

3. **보안**
   - 뽑히지 않은 티켓의 rank 정보가 null로 반환되는지 확인

4. **캐싱 방지**
   - 캐싱 방지 헤더가 올바르게 설정되는지 확인

## 테스트 데이터

테스트는 모킹된 Prisma 클라이언트를 사용하므로 실제 DB에 영향을 주지 않습니다.

실제 DB를 사용한 통합 테스트를 실행하려면:
1. `.env.test` 파일에 테스트용 DB 연결 정보 설정
2. `USE_REAL_DB=true npm test` 실행
