// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")  // 6543 포트 (데이터 조회용)
  directUrl = env("DIRECT_URL")    // 5432 포트 (이 줄이 있어야 db push가 멈추지 않음!)
}

model User {
  id            Int       @id @default(autoincrement())
  email         String    @unique
  password      String?   // 구글 로그인 사용자는 비밀번호 없음
  nickname      String?
  points        Float     @default(0)
  level         Int       @default(1)
  userType      Int       @default(0) // 0: Normal User, 1: Admin
  lastLoginDate DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  posts         Post[]
  comments      Comment[]
  gameLogs      GameLog[] // 게임 기록 관계
  gameScores    GameScore[] // 게임 점수 기록 (스코어링 게임용)
  billboardEvents BillboardEvent[] // 전광판 이벤트
  achievements  UserAchievement[] // 획득한 업적 관계
  likes         Like[]    // 좋아요 한 기록
  missionRewards Json?    @default("[]") // 수령한 미션 보상 목록 (예: ["post_10", "comment_50"])
  holdemPlayers HoldemPlayer[] // 홀덤 플레이어 관계
  tetrisPlayers TetrisPlayer[] // 테트리스 플레이어 관계
  passwordResetTokens PasswordResetToken[] // 비밀번호 재설정 토큰
  gameSessions GameSession[] // 게임 베팅 세션
  pet           Pet?          // 펫 관계 (1:1)
}

model Post {
  id        Int       @id @default(autoincrement())
  title     String
  content   String   @db.Text
  authorId  Int
  author    User      @relation(fields: [authorId], references: [id])
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  comments  Comment[]
  likes     Like[]    // 좋아요 받은 기록
  views     Int       @default(0) // 조회수
}

model Like {
  id        Int      @id @default(autoincrement())
  userId    Int
  postId    Int
  user      User     @relation(fields: [userId], references: [id])
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
}

model Comment {
  id        Int       @id @default(autoincrement())
  content   String    @db.Text
  postId    Int
  post      Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  authorId  Int
  author    User      @relation(fields: [authorId], references: [id])
  parentId  Int?      // 대댓글을 위한 부모 댓글 ID
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentReplies")
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model KujiBox {
  id        Int       @id @default(autoincrement())
  boxNumber Int       @default(1) // 박스 번호
  isActive  Boolean   @default(true) // 현재 활성 박스인지
  tickets   KujiTicket[]
  prizeInfo Json?     // [NEW] 박스별 경품 메타데이터 (등급, 이름, 이미지, 컬러 등)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model KujiTicket {
  id        Int      @id @default(autoincrement())
  boxId     Int
  box       KujiBox  @relation(fields: [boxId], references: [id], onDelete: Cascade)
  ticketId  Int      // 티켓 번호 (0-79)
  rank      String   // 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'LAST_ONE'
  isTaken   Boolean  @default(false) // 뽑혔는지 여부
  takenBy   Int?     // 뽑은 사용자 ID (선택사항)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([boxId, ticketId])
}

model EmailVerification {
  id        Int      @id @default(autoincrement())
  email     String
  code      String   // 인증 코드 (6자리)
  verified  Boolean  @default(false) // 인증 완료 여부
  expiresAt DateTime // 만료 시간 (10분)
  createdAt DateTime @default(now())

  @@index([email, code])
  @@index([email])
}

// 비밀번호 재설정 토큰
model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique // 재설정 토큰
  expiresAt DateTime // 만료 시간 (1시간)
  used      Boolean  @default(false) // 사용 여부
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

// 게임 베팅 세션 (보안 강화용)
model GameSession {
  id        String   @id @default(uuid())
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  gameType  String   // 'blackjack', 'bustabit', 'roulette', 'cloverpit'
  betAmount Float    // 베팅 금액
  status    String   @default("pending") // 'pending', 'settled', 'cancelled'
  gameData  Json?    // 게임별 데이터 (카드, 랜덤 시드 등)
  result    String?  // 서버에서 계산한 결과
  payout    Float?   // 서버에서 계산한 지급액
  createdAt DateTime @default(now())
  settledAt DateTime?

  @@index([userId])
  @@index([gameType])
  @@index([status])
  @@index([createdAt])
}

// 게임 기록 저장용 모델 (베팅/자산 변동용)
model GameLog {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  sessionId String?  // GameSession ID (선택사항)
  gameType  String   // 'blackjack', 'bustabit', 'kuji', 'cloverpit'
  betAmount Float      // 베팅 금액
  payout    Float      // 획득 금액 (0이면 패배)
  profit    Float      // 순수익 (payout - betAmount)
  result    String   // 'WIN', 'LOSE', 'DRAW', 'JACKPOT' 등
  multiplier Float?  // 배당률 (옵션)
  metadata  Json?    // 추가 상세 정보 (쿠지 등급 등)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([gameType])
  @@index([createdAt])
  @@index([sessionId])
}

// 게임 점수 저장용 모델 (랭킹용 - 계단오르기 등)
model GameScore {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  gameType  String   // 'stairs'
  score     Int
  createdAt DateTime @default(now())

  @@index([gameType, score]) // 랭킹 조회 최적화
  @@index([userId])
}

// 전광판 이벤트 (홈 화면 노출용)
model BillboardEvent {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  gameType  String   // 'blackjack', 'bustabit', 'kuji', 'cloverpit', 'roulette', 'stairs'
  message   String   // 노출할 메시지
  createdAt DateTime @default(now())

  @@index([createdAt])
}

// 업적 정의
model Achievement {
  id          Int      @id @default(autoincrement())
  code        String   @unique // 예: 'FIRST_WIN', 'LEVEL_10'
  name        String
  description String
  icon        String   // 이모지 또는 이미지 URL
  condition   Json?    // 달성 조건 (선택 사항)
  users       UserAchievement[]
}

// 사용자 획득 업적
model UserAchievement {
  id            Int         @id @default(autoincrement())
  userId        Int
  achievementId Int
  earnedAt      DateTime    @default(now())
  user          User        @relation(fields: [userId], references: [id])
  achievement   Achievement @relation(fields: [achievementId], references: [id])

  @@unique([userId, achievementId])
  @@index([userId])
}

// 홀덤 게임 방
model HoldemRoom {
  id            String   @id @default(uuid())
  name          String
  maxPlayers    Int      @default(6)
  smallBlind    Float    @default(10)
  bigBlind      Float    @default(20)
  status        String   @default("waiting") // 'waiting', 'playing', 'finished'
  currentRound  String?  // 'preflop', 'flop', 'turn', 'river', 'showdown'
  pot           Float    @default(0)
  dealerIndex   Int      @default(0)
  communityCards Json?   // 공통 카드 5장
  gameState     Json?    // 게임 상태 전체 (덱, 현재 플레이어 등)
  turnStartTime DateTime? // 현재 턴 시작 시간 (타이머용)
  showdownEndTime DateTime? // showdown 종료 시간 (자동 시작용)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  players       HoldemPlayer[]

  @@index([status])
  @@index([createdAt])
}

// 홀덤 플레이어 (방 참여자)
model HoldemPlayer {
  id          Int      @id @default(autoincrement())
  roomId      String
  room        HoldemRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  seatIndex   Int      // 좌석 번호 (0-8)
  holeCards   Json?    // 손패 2장 [{suit, rank}, {suit, rank}]
  chips       Float    // 현재 칩 수
  currentBet  Float    @default(0) // 이번 라운드 베팅액
  isActive    Boolean  @default(true) // 폴드했는지
  isAllIn     Boolean  @default(false)
  position    String?  // 'dealer', 'small_blind', 'big_blind', 'utg' 등
  createdAt   DateTime @default(now())
  
  @@unique([roomId, userId])
  @@unique([roomId, seatIndex])
  @@index([roomId])
  @@index([userId])
}

// 테트리스 게임 방
model TetrisRoom {
  id            String   @id @default(uuid())
  name          String?
  mode          String   @default("single") // 'single', 'multiplayer'
  status        String   @default("waiting") // 'waiting', 'playing', 'finished'
  gameState     Json?    // 게임 상태 (플레이어별 그리드, 점수 등)
  winnerId      Int?     // 승자 ID (멀티플레이어 모드)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  players       TetrisPlayer[]

  @@index([status])
  @@index([mode])
  @@index([createdAt])
}

// 테트리스 플레이어 (방 참여자)
model TetrisPlayer {
  id          Int      @id @default(autoincrement())
  roomId      String
  room        TetrisRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  playerIndex Int      @default(0) // 플레이어 인덱스 (0 또는 1)
  score       Int      @default(0) // 현재 점수
  lines       Int      @default(0) // 제거한 라인 수
  level       Int      @default(1) // 현재 레벨
  isGameOver  Boolean  @default(false) // 게임 오버 여부
  grid        Json?    // 현재 그리드 상태
  currentPiece Json?   // 현재 블록 정보
  nextPiece   Json?    // 다음 블록 정보
  createdAt   DateTime @default(now())
  
  @@unique([roomId, userId])
  @@unique([roomId, playerIndex])
  @@index([roomId])
  @@index([userId])
}

// 펫 (다마고치)
model Pet {
  id            Int      @id @default(autoincrement())
  userId        Int      @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name          String   @default("펫")
  type          String   @default("default") // 펫 타입 (나중에 확장 가능)
  level         Int      @default(1) // 펫 레벨
  exp           Int      @default(0) // 경험치
  hunger        Int      @default(80) // 배고픔 (0-100)
  happiness     Int      @default(80) // 행복도 (0-100)
  health        Int      @default(100) // 건강 (0-100)
  poop          Int      @default(0) // 똥 개수 (0-5)
  lastFedAt     DateTime? // 마지막 밥 준 시간
  lastPlayedAt  DateTime? // 마지막 놀아준 시간
  lastCleanedAt DateTime? // 마지막 똥 치운 시간
  lastDecayAt   DateTime  @default(now()) // 마지막 상태 감소 시간
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([userId])
}
