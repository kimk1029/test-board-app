// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")  // 6543 포트 (데이터 조회용)
  directUrl = env("DIRECT_URL")    // 5432 포트 (이 줄이 있어야 db push가 멈추지 않음!)
}

model User {
  id            Int       @id @default(autoincrement())
  email         String    @unique
  password      String
  nickname      String?
  points        Float     @default(0)
  level         Int       @default(1)
  lastLoginDate DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  posts         Post[]
  comments      Comment[]
  gameLogs      GameLog[] // 게임 기록 관계
  gameScores    GameScore[] // 게임 점수 기록 (스코어링 게임용)
  billboardEvents BillboardEvent[] // 전광판 이벤트
  achievements  UserAchievement[] // 획득한 업적 관계
  likes         Like[]    // 좋아요 한 기록
  missionRewards Json?    @default("[]") // 수령한 미션 보상 목록 (예: ["post_10", "comment_50"])
}

model Post {
  id        Int       @id @default(autoincrement())
  title     String
  content   String   @db.Text
  authorId  Int
  author    User      @relation(fields: [authorId], references: [id])
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  comments  Comment[]
  likes     Like[]    // 좋아요 받은 기록
  views     Int       @default(0) // 조회수
}

model Like {
  id        Int      @id @default(autoincrement())
  userId    Int
  postId    Int
  user      User     @relation(fields: [userId], references: [id])
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
}

model Comment {
  id        Int       @id @default(autoincrement())
  content   String    @db.Text
  postId    Int
  post      Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  authorId  Int
  author    User      @relation(fields: [authorId], references: [id])
  parentId  Int?      // 대댓글을 위한 부모 댓글 ID
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentReplies")
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model KujiBox {
  id        Int       @id @default(autoincrement())
  boxNumber Int       @default(1) // 박스 번호
  isActive  Boolean   @default(true) // 현재 활성 박스인지
  tickets   KujiTicket[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model KujiTicket {
  id        Int      @id @default(autoincrement())
  boxId     Int
  box       KujiBox  @relation(fields: [boxId], references: [id], onDelete: Cascade)
  ticketId  Int      // 티켓 번호 (0-79)
  rank      String   // 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'LAST_ONE'
  isTaken   Boolean  @default(false) // 뽑혔는지 여부
  takenBy   Int?     // 뽑은 사용자 ID (선택사항)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([boxId, ticketId])
}

model EmailVerification {
  id        Int      @id @default(autoincrement())
  email     String
  code      String   // 인증 코드 (6자리)
  verified  Boolean  @default(false) // 인증 완료 여부
  expiresAt DateTime // 만료 시간 (10분)
  createdAt DateTime @default(now())

  @@index([email, code])
  @@index([email])
}

// 게임 기록 저장용 모델 (베팅/자산 변동용)
model GameLog {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  gameType  String   // 'blackjack', 'bustabit', 'kuji', 'cloverpit'
  betAmount Float      // 베팅 금액
  payout    Float      // 획득 금액 (0이면 패배)
  profit    Float      // 순수익 (payout - betAmount)
  result    String   // 'WIN', 'LOSE', 'DRAW', 'JACKPOT' 등
  multiplier Float?  // 배당률 (옵션)
  metadata  Json?    // 추가 상세 정보 (쿠지 등급 등)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([gameType])
  @@index([createdAt])
}

// 게임 점수 저장용 모델 (랭킹용 - 계단오르기 등)
model GameScore {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  gameType  String   // 'stairs'
  score     Int
  createdAt DateTime @default(now())

  @@index([gameType, score]) // 랭킹 조회 최적화
  @@index([userId])
}

// 전광판 이벤트 (홈 화면 노출용)
model BillboardEvent {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  gameType  String   // 'blackjack', 'bustabit', 'kuji', 'cloverpit', 'roulette', 'stairs'
  message   String   // 노출할 메시지
  createdAt DateTime @default(now())

  @@index([createdAt])
}

// 업적 정의
model Achievement {
  id          Int      @id @default(autoincrement())
  code        String   @unique // 예: 'FIRST_WIN', 'LEVEL_10'
  name        String
  description String
  icon        String   // 이모지 또는 이미지 URL
  condition   Json?    // 달성 조건 (선택 사항)
  users       UserAchievement[]
}

// 사용자 획득 업적
model UserAchievement {
  id            Int         @id @default(autoincrement())
  userId        Int
  achievementId Int
  earnedAt      DateTime    @default(now())
  user          User        @relation(fields: [userId], references: [id])
  achievement   Achievement @relation(fields: [achievementId], references: [id])

  @@unique([userId, achievementId])
  @@index([userId])
}
